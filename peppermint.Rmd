---
title: "Peppermint"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
    theme: journal
    source_code: embed
runtime: shiny
---

```{r setup, include=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, errors = FALSE)
library(flexdashboard)
library(dplyr)
library(lubridate)
library(DT)
library(plotly)
library(padr)

source("data_prep.R")

current_month <- as_date(floor_date(with_tz(Sys.time(), "US/Eastern"), "month"))
```

Column {data-width=500, .tabset}
-----------------------------------------------------------------------

### This Month's Spending

```{r spending_current}
spending_current <- transactions %>%
  dplyr::filter(month ==  current_month & # current month only
                  !(category %in% c("savings", "income")) & 
                  type == "out") # outgoing transactions only

spending_by_category <- spending_current %>%
  group_by(category) %>%
  summarise(amount = sum(amount, na.rm = TRUE)) %>%
  full_join(spending_budget, by = "category") %>%
  fill_by_value(amount, budget, 0) %>%
  mutate(prop_spent = if_else(budget == 0, 
                              NA_real_,
                              amount/budget),
         percent_spent = if_else(budget == 0,
                                 "No budget",
                                 paste0(round(prop_spent*100), "%")))

plot_ly(data = spending_by_category) %>%
  add_trace(
    x = ~ amount,
    y = ~ category,
    type = "bar",
    hoverinfo = "text",
    text = ~ paste0("spending: $", format(amount, nsmall = 2), "<br> budget: $", budget)) %>%
  add_trace(
    x = ~ budget, 
    y= ~ category, 
    type = "scatter", 
    mode = "markers",
    hoverinfo = "text",
    text = ~ paste0("budget: $", format(budget, nsmall = 2))) %>%
  layout(margin = list(l = 8*max(nchar(as.character(spending_by_category[["category"]])))),
         yaxis = list(title = ""),
         xaxis = list(title = "", tickprefix = "$"),
         showlegend = FALSE)
```

### Transactions

```{r transactions_current}
datatable(spending_current %>% 
            select(date, amount, description, category) %>%
            arrange(desc(date)),
          options = list(pageLength = 10))
```

Column {data-width=500}
-----------------------------------------------------------------------

### Overall Spending

```{r spending_over_time, fig.width=6, fig.height=2.5}
spending_over_time <- transactions %>%
  dplyr::filter(!(category %in% c("savings", "income")) &
                  type == "out") %>%
  group_by(month) %>%
  summarise(amount = sum(amount)) %>%
  full_join(
    tibble(month = current_month),
    by = "month") %>%
  fill_by_value(amount, 0)

plot_ly(data = spending_over_time) %>%
  add_trace(
    x = ~ month,
    y = ~ amount,
    type = "bar",
    hoverinfo = "text",
    text = ~paste0("$", format(amount, nsmall = 2), " (", month(month, label = TRUE), ")")) %>%
  layout(yaxis = list(title = ""),
         xaxis = list(title = ""))
```

### This Month's Savings

```{r savings_current, echo=FALSE}
savings_current <- transactions %>%
  dplyr::filter(month == current_month &
                  category == "savings") %>%
  mutate(amount = if_else(type == "in", 1, -1)*amount) %>%
  summarise(savings = sum(amount)) %>%
  pull(savings) %>%
  round(0)

gauge(savings_current,
      min = 0, max = monthly_savings,
      abbreviate = F,
      gaugeSectors(
        success = c(monthly_savings*0.75, monthly_savings),
        warning = c(monthly_savings*0.50, monthly_savings*0.75-1),
        danger = c(0, monthly_savings*0.50-1),
        colors = c("#F8AFA8", "#FDDDA0", "#74A089"))
)
```

### Overall Savings

```{r savings_over_time, echo=FALSE}
savings <- savings_history %>%
  mutate(month = floor_date(date, "month")) %>%
  select(date, month, amount, type) %>%
  bind_rows(transactions %>% 
              filter(category == "savings") %>%
              select(date, month, amount, type)) %>%
  arrange(date) %>%
  mutate(savings = cumsum(amount*if_else(type == "in", 1, -1)))

savings_by_month <- savings %>%
  group_by(month) %>%
  filter(row_number() == n()) %>%
  ungroup() %>%
  full_join(
    tibble(month = current_month),
    by = "month") %>%
  fill_by_value(savings, lag(savings, order_by = month))

plot_ly(data = savings_by_month) %>%
  add_trace(
    x = ~ month,
    y = ~ savings,
    type = "scatter",
    mode = "lines",
    hoverinfo = "text",
    text = ~paste0("$", format(savings, nsmall = 2), " (", month(month, label = TRUE), ")")) %>%
  layout(yaxis = list(title = "", rangemode = "tozero"),
         xaxis = list(title = ""))
```

